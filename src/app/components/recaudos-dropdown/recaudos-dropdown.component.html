<div class="convenio-recaudo-container">

  <div class="row">
    <div class="col-12">
      <div class="page-title-box d-sm-flex align-items-center justify-content-between">
        <div class="page-title-right">
          <ol class="breadcrumb m-0">
            <h4 class="mb-sm-0 btn-outline-primary"> <span *ngIf="!showFormulario">Convenios Configurados</span>
              <span *ngIf="showFormulario">
                {{ isEditMode ? 'Editar Convenio de Recaudo' : 'Nuevo Convenio de Recaudo' }}
              </span>
            </h4>
          </ol>
        </div>

        <div class="page-title-right">
          <ol class="breadcrumb m-0">
            <li class="breadcrumb-item"><a>Configurar Recaudos</a></li>
            <li class="breadcrumb-item active">Gestiona Recaudos</li>
          </ol>
        </div>
      </div>
    </div>
  </div>
  <!-- Header -->

  <!-- Mensaje de √âxito -->
  <div class="success-message-overlay" *ngIf="showSuccessMessage">
    <div class="success-message-container">
      <div class="success-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="success-content">
        <h5>¬°Operaci√≥n Exitosa!</h5>
        <p>{{ successMessage }}</p>
      </div>
      <button type="button" class="close-success-btn" (click)="cerrarMensajeExito()">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <!-- Botones de Acci√≥n Globales -->



  <div class="col-lg-12">
    <div class="card">
      <div class="card-header align-items-center d-flex">
        <h4 class="card-title mb-0 flex-grow-1">
          <li class="p-2 border-bottom zoom" style="list-style: none;">
            <button class="btn btn-outline-warning mb-2" data-bs-toggle="tooltip" [disabled]="showFormulario"
              (click)="mostrarFormulario()" title="Nuevo Registro">
              <i class="fa fa-plus-square fa-lg"></i>
            </button>

            <button class="btn btn-outline-success mb-2" data-bs-toggle="tooltip" [disabled]="!showFormulario"
              [class.loading]="isSaving" (click)="guardarConfiguracion()"
              [title]="isEditMode ? 'Actualizar' : 'Guardar'">
              <i class="fa fa-floppy-o fa-lg"></i>
            </button>

            <button class="btn btn-outline-danger mb-2" data-bs-toggle="tooltip" title="Anular Registro "
              [disabled]="!showFormulario && !hasSelections()" (click)="cancelarOperacion()">
              <i class="fa fa-ban fa-lg"></i>
            </button>

            <!-- Bot√≥n de b√∫squeda deshabilitado (comentado como en el original) -->
            <!--
          <button class="btn btn-outline-primary mb-2" data-bs-toggle="tooltip" title="Buscar Registro" (click)="buscar()">
            <i class="fa fa-search fa-2x"></i>
          </button>
          -->
          </li>
        </h4>
      </div>
    </div>
  </div>


  <div class="global-action-section">


    <!-- Messages Section -->



    <div class="messages-section">
      <!-- Mensaje de √©xito -->
      <div *ngIf="saveSuccess" class="success-message">
        <span class="success-icon">‚úÖ</span>
        <span class="success-text">Configuraci√≥n guardada exitosamente</span>
      </div>

      <!-- Mensaje de error espec√≠fico para guardar -->
      <div *ngIf="error && !isLoading" class="error-message-inline">
        <span class="error-icon"><i class="ri-error-warning-line me-3 align-middle"></i></span>

        <strong>
          {{ error }}
        </strong>
      </div>

      <div *ngIf="error && !(loading$ | async)" class="error-message-inline">
        <span class="error-icon"><i class="ri-error-warning-line me-3 align-middle"></i></span>
        <strong>
          {{ error }}
        </strong>
      </div>

      <!-- Informaci√≥n de ayuda para la lista -->
      <div class="help-info"
        *ngIf="!showFormulario && conveniosConfigurados.length === 0 && !(loading$ | async) && !error">
        <span class="help-icon">üìù</span>
        <span class="help-text">No hay convenios configurados. Haga clic en "Guardar" para crear uno nuevo.</span>
      </div>
    </div>
  </div>

  <!-- Lista de Convenios Configurados -->


  <div *ngIf="!showFormulario" class="lista-container">
    <!-- Loading State -->
    <app-loading></app-loading>

    <div *ngIf="isLoading" class="loading-section">

      <p class="loading-text">Cargando convenios configurados...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !isLoading" class="col-lg-12">
      <div class="card">
        <div class="row">
          <div class="col-md-12">
            <div class="mt-0">
              <div class="card card-body text-center">
                <div class="text-center">

                  <span>
                    <div class="alert alert-danger alert-border-left alert-dismissible fade show" role="alert">

                      <strong>
                        {{ error }}
                      </strong>
                      <div class="mt-2">
                        <button class="btn btn-danger btn-sm" (click)="loadConveniosConfigurados()">
                          Reintentar
                        </button>
                      </div>
                      <i class="ri-error-warning-line me-3 align-middle"></i>
                    </div>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Tabla de Convenios -->
    <div *ngIf="!isLoading && !error" class="table-container">
      
      <!-- Informaci√≥n de registros -->
      <div *ngIf="conveniosConfigurados.length > 0" class="records-info">
        <span class="records-text">
          Mostrando {{ ((paginaActual - 1) * tamanoPagina) + 1 }} - 
          {{ Math.min(paginaActual * tamanoPagina, getTotalRegistros()) }} 
          de {{ getTotalRegistros() }} registros
        </span>
      </div>
      
      <div class="table-content">
        <table class="convenios-table">
          <thead>
            <tr>
              <th>Nivel de Recaudo</th>
              <th>Fecha Creaci√≥n</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let convenio of conveniosConfigurados" class="table-row">
              <td>{{ convenio.nivelRecaudoNombre }}</td>
              <td>{{ formatearFecha(convenio.fechaCreacion) }}</td>
              <td>
                <span class="status-badge" [class.active]="convenio.activo" [class.inactive]="!convenio.activo">
                  {{ convenio.activo ? 'Activo' : 'Inactivo' }}
                </span>
              </td>
              <td>
                <div class="action-buttons">
                  <button type="button" class="btn btn-outline-info btn-icon waves-effect waves-light"
                    data-bs-toggle="tooltip" data-bs-placement="top" title="Editar" (click)="editarConvenio(convenio)">
                    <i class="las la-user-alt"></i>
                  </button>

                  <a class="btn btn-outline-danger btn-icon waves-effect waves-light" title="Inactivar"
                    (click)="eliminarConvenio(convenio)">
                    <i class="las la-exclamation-circle"></i>
                  </a>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Empty State -->
        <div *ngIf="conveniosConfigurados.length === 0" class="empty-state">
          <div class="empty-icon">üìã</div>
          <h3>No hay convenios configurados</h3>
          <p>Crea tu primer convenio de recaudo haciendo clic en "Nuevo Convenio"</p>
          <button class="add-button primary" (click)="mostrarFormulario()">
            <span class="button-icon">‚ûï</span>
            <span class="button-text">Crear Primer Convenio</span>
          </button>
        </div>
      </div>

      <!-- Paginaci√≥n y Controles -->
      <div *ngIf="!isLoading && !error" class="pagination-container" [class.only-selector]="soloMostrarSelector()">
        <!-- Navegaci√≥n de p√°ginas (solo si hay m√°s de una p√°gina) -->
        <div *ngIf="totalPaginas > 1" class="pagination">
          <button class="pagination-button" [disabled]="paginaActual === 1" (click)="cambiarPagina(paginaActual - 1)">
            ‚Äπ Anterior
          </button>

          <button *ngFor="let pagina of getPaginas()" class="pagination-button" [class.active]="pagina === paginaActual"
            (click)="cambiarPagina(pagina)">
            {{ pagina }}
          </button>

          <button class="pagination-button" [disabled]="paginaActual === totalPaginas"
            (click)="cambiarPagina(paginaActual + 1)">
            Siguiente ‚Ä∫
          </button>
        </div>
        
        <!-- Dropdown para seleccionar tama√±o de p√°gina (siempre visible) -->
        <div class="page-size-selector">
          <label for="pageSize">Mostrar:</label>
          <select 
            id="pageSize" 
            [(ngModel)]="tamanoPagina" 
            (change)="cambiarTamanoPagina(tamanoPagina)"
            class="page-size-dropdown">
            <option 
              *ngFor="let opcion of opcionesTamanoPagina" 
              [value]="opcion.valor">
              {{ opcion.etiqueta }}
            </option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="showFormulario" class="formulario-container">

    <!-- Estado de carga -->
    <app-loading *ngIf="loading$ | async"></app-loading>
    <!--             
    <div *ngIf="isLoading" class="loading-state">
      <div class="spinner"></div>
      <p>Cargando recaudos, √°mbitos, excepciones y programas...</p>
    </div> -->

    <!-- Estado de error -->
    <div *ngIf="error && !isLoading" class="error-state">
      <div class="error-icon">‚ö†Ô∏è</div>
      <p class="error-message">{{ error }}</p>
      <button class="retry-button" (click)="retry()">Reintentar</button>
    </div>

    <!-- Main Grid Layout -->
    <div *ngIf="!isLoading && !error">

      <div class="card outline-badge-primary m-3">
        <div class="card-content">
          <div class="card-body p-3">
            <div class="d-md-flex">

              <div class="content px-md-3 my-3 my-md-0">
                <span class="mb-0 font-w-600 h5">Recaudo</span><br>

              </div>

            </div>

          </div>
        </div>
      </div>

      <!-- Sidebar con Recaudos -->
      <div class="sidebar-section  ">
        <div class="section-card">
          <!-- <div class="card-header">
            <h2 class="card-title">Recaudos Disponibles</h2>
            <span class="badge">{{ recaudos.length }}</span>
          </div> -->


          <div class="select">

            
            <p-select class="w-full md:w-56" [options]="recaudos" [(ngModel)]="selectedRecaudo" optionLabel="name"
              optionValue="" [filter]="true" placeholder="Seleccionar recaudo..." [disabled]="recaudos.length === 0"
              (onChange)="onRecaudoSelect($event)">
            </p-select>

          </div>






          <!-- Info del recaudo seleccionado -->

        </div>
      </div>


    </div>

    <div class="card outline-badge-primary m-3">
      <div class="card-content">
        <div class="card-body p-3">
          <div class="d-md-flex">

            <div class="content px-md-3 my-3 my-md-0">
              <span class="mb-0 font-w-600 h5">Excepciones</span><br>

            </div>

          </div>

        </div>
      </div>
    </div>


    <div class="row m-1">



      <div class="col-12 col-lg-6 col-xl-4 mt-3">
        <div class="card text-center">
          <!-- Card Header -->
          <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">√Åmbitos</h4>

            <!-- Checkbox "Seleccionar todos" -->
            <div class="form-check ">
              <input type="checkbox" class="form-check-input" id="toggleAllAmbitos" [checked]="isAllAmbitosSelected()"
                [class.indeterminate]="isAmbitosIndeterminate()" (change)="toggleSelectAllAmbitos()">
              <label class="form-check-label" for="toggleAllAmbitos">
                Seleccionar todos
              </label>
            </div>
          </div>

          <!-- Card Body -->
          <div class="card-body">


            <!-- Lista de opciones -->
            <div class="d-flex flex-wrap gap-2 justify-content-center">
              <div *ngFor="let ambito of ambitos; trackBy: trackByAmbitoId" class="border rounded py-2 px-4 m-1"
                [class.bg-light]="ambito.selected">
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" [id]="'ambito-' + ambito.id"
                    [checked]="ambito.selected" (change)="onAmbitoSelectionChange(ambito)">
                  <label class="form-check-label" [for]="'ambito-' + ambito.id">
                    {{ ambito.name }}
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Card Footer -->
          <div *ngIf="getSelectedAmbitosCount() > 0" class="card-footer btn btn-primary">
            <i class="bx bx-check "></i>
            <span class="small ">{{ getSelectedAmbitosCount() }} √°mbitos seleccionados</span>
          </div>



        </div>
      </div>
      <div class="col-12 col-lg-6 col-xl-4 mt-3">
        <div class="card text-center">

          <!-- Card Header -->
          <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Programas</h4>

            <!-- Contador y seleccionar todos -->
            <div class="d-flex align-items-center">

              <div class="form-check mb-0">
                <input type="checkbox" class="form-check-input" id="toggleAllProgramas"
                  [checked]="isAllProgramasSelected()" [class.indeterminate]="isProgramasIndeterminate()"
                  (change)="toggleSelectAllProgramas()">
                <label class="form-check-label" for="toggleAllProgramas">
                  Seleccionar todos
                </label>
              </div>
            </div>
          </div>

          <!-- Card Body -->
          <div class="card-body">

            <!-- Debug info -->
            <div *ngIf="programas.length === 0 && !isLoading" class="alert alert-warning w-100">
              <strong>‚ÑπÔ∏è No hay programas de convenio disponibles.</strong>
              <div class="small">Verifique la conexi√≥n o contacte al administrador.</div>
            </div>

            <!-- Loading -->
            <div *ngIf="isLoading" class="text-center w-100 py-3">
              <div class="spinner-border text-primary"></div>
              <p class="mt-2 mb-0">Cargando programas de convenio...</p>
            </div>

            <!-- Lista de programas -->
            <div class="d-flex flex-wrap gap-2 justify-content-center" *ngIf="!isLoading && programas.length > 0">
              <div *ngFor="let programa of programas; trackBy: trackByProgramaId" class="border rounded py-2 px-2 m-1"
                [class.bg-light]="programa.selected">
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" [id]="'programa-' + programa.id"
                    [checked]="programa.selected" (change)="onProgramaSelectionChange(programa)">
                  <label class="form-check-label" [for]="'programa-' + programa.id">
                    {{ programa.name }}
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Card Footer -->
          <div *ngIf="getSelectedProgramasCount() > 0" class="card-footer btn btn-primary py-2">
            <i class="bx bx-check"></i>
            <span class="small ms-2">
              {{ getSelectedProgramasCount() }} programas seleccionados
            </span>
          </div>

        </div>

      </div>
      <div class="col-12 col-lg-6 col-xl-4 mt-3">
        <div class="card text-center">

          <!-- Card Header -->
          <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Otras </h4>

            <!-- Checkbox "Seleccionar todas" -->
            <div class="form-check mb-0">
              <input type="checkbox" class="form-check-input" id="toggleAllExcepciones"
                [checked]="isAllExcepcionesSelected()" [class.indeterminate]="isExcepcionesIndeterminate()"
                (change)="toggleSelectAllExcepciones()">
              <label class="form-check-label" for="toggleAllExcepciones">
                Seleccionar todas
              </label>
            </div>
          </div>

          <!-- Card Body -->
          <div class="card-body">
            <div class="d-flex flex-wrap gap-2 justify-content-center">
              <div *ngFor="let excepcion of excepciones; trackBy: trackByExcepcionId"
                class="border rounded py-2 px-2 m-1" [class.bg-light]="excepcion.selected">
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" [id]="'excepcion-' + excepcion.id"
                    [checked]="excepcion.selected" (change)="onExcepcionSelectionChange(excepcion)">
                  <label class="form-check-label" [for]="'excepcion-' + excepcion.id">
                    {{ excepcion.name }}
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Card Footer -->
          <div *ngIf="getSelectedExcepcionesCount() > 0" class="card-footer btn btn-primary py-2">
            <i class="bx bx-check"></i>
            <span class="small ms-2">
              {{ getSelectedExcepcionesCount() }} excepciones seleccionadas
            </span>
          </div>

        </div>
      </div>






    </div>





    <!-- Estado sin datos -->

    <div *ngIf="!isLoading && !error && recaudos.length === 0" class="empty-state">
      <div class="empty-icon">üìã</div>
      <h3>No hay recaudos disponibles</h3>
      <p>No se encontraron recaudos para mostrar en este momento.</p>
    </div>
  </div>

  <!-- Modal de Confirmaci√≥n para Desactivar Convenio -->
  <div class="modal-overlay" *ngIf="showDeleteModal" (click)="cancelarEliminacion()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">
          <i class="fas fa-exclamation-triangle warning-icon"></i>
          <h4>Confirmar Desactivaci√≥n</h4>
        </div>
        <button type="button" class="close-button" (click)="cancelarEliminacion()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="confirmation-content">
          <div class="warning-section">
            <i class="fas fa-info-circle info-icon"></i>
            <p class="main-message">¬øEst√° seguro de que desea desactivar la siguiente configuraci√≥n de convenio?</p>
          </div>
          
          <div class="convenio-details" *ngIf="convenioToDelete">
            <div class="detail-card">
              <div class="detail-row">
                <span class="detail-label">Nivel de Recaudo:</span>
                <span class="detail-value">{{ convenioToDelete.nivelRecaudoNombre }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Estado Actual:</span>
                <span class="detail-value status-active">Activo</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Fecha de Creaci√≥n:</span>
                <span class="detail-value">{{ formatearFecha(convenioToDelete.fechaCreacion) }}</span>
              </div>
            </div>
          </div>
          
          <div class="warning-notice">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Esta acci√≥n no se puede deshacer. El convenio ser√° desactivado permanentemente.</span>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelarEliminacion()">
          <i class="fas fa-times"></i>
          Cancelar
        </button>
        <button type="button" class="btn btn-danger" (click)="confirmarEliminacion()">
          <i class="fas fa-ban"></i>
          Desactivar Convenio
        </button>
      </div>
    </div>
  </div>
</div>